<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Eddy-Diffusivity Mass-Flux (EDMF) equations · CLIMA</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><a href="../../index.html"><img class="logo" src="../../assets/logo.svg" alt="CLIMA logo"/></a><h1>CLIMA</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../">Home</a></li><li><span class="toctext">Utilites</span><ul><li><a class="toctext" href="../../Utilities/RootSolvers/">RootSolvers</a></li><li><a class="toctext" href="../../Utilities/MoistThermodynamics/">MoistThermodynamics</a></li></ul></li><li><span class="toctext">Atmos</span><ul><li><a class="toctext" href="../SurfaceFluxes/"><code>SurfaceFluxes</code></a></li><li><a class="toctext" href="../TurbulenceConvection/"><code>TurbulenceConvection</code></a></li><li class="current"><a class="toctext" href>Eddy-Diffusivity Mass-Flux (EDMF) equations</a><ul class="internal"><li><a class="toctext" href="#Domain-decomposition-1">Domain decomposition</a></li><li><a class="toctext" href="#Domain-averaged-equations-1">Domain averaged equations</a></li><li><a class="toctext" href="#Sub-domain-equations:-Area-fraction-1">Sub-domain equations: Area fraction</a></li><li><a class="toctext" href="#Sub-domain-equations:-1st-moment-1">Sub-domain equations: 1st moment</a></li><li><a class="toctext" href="#Sub-domain-equations:-2nd-moment-1">Sub-domain equations: 2nd moment</a></li><li class="toplevel"><a class="toctext" href="#EDMF-variable-definitions-1">EDMF variable definitions</a></li><li><a class="toctext" href="#Constants-1">Constants</a></li><li><a class="toctext" href="#Phase-partition-1">Phase partition</a></li><li><a class="toctext" href="#Gas-constants-1">Gas constants</a></li><li><a class="toctext" href="#Specific-heats-1">Specific heats</a></li><li><a class="toctext" href="#Latent-heat-1">Latent heat</a></li><li><a class="toctext" href="#Exner-functions-1">Exner functions</a></li><li><a class="toctext" href="#Temperature-1">Temperature</a></li><li><a class="toctext" href="#Reference-state-profiles-1">Reference state profiles</a></li><li><a class="toctext" href="#Mixing-ratios-1">Mixing ratios</a></li><li><a class="toctext" href="#Potential-temperatures-1">Potential temperatures</a></li><li><a class="toctext" href="#Shear-production-1">Shear production</a></li><li><a class="toctext" href="#Buoyancy-1">Buoyancy</a></li><li><a class="toctext" href="#Buoyancy-gradient-1">Buoyancy gradient</a></li><li><a class="toctext" href="#Surface-fluxes-1">Surface fluxes</a></li><li><a class="toctext" href="#Prandtl-number-1">Prandtl number</a></li><li><a class="toctext" href="#Mixing-length-1">Mixing length</a></li><li><a class="toctext" href="#Eddy-diffusivity-1">Eddy diffusivity</a></li><li><a class="toctext" href="#Buoyancy-flux-1">Buoyancy flux</a></li><li><a class="toctext" href="#Entrainment-Detrainment-1">Entrainment-Detrainment</a></li><li><a class="toctext" href="#Inversion-height-1">Inversion height</a></li><li><a class="toctext" href="#Convective-velocity-1">Convective velocity</a></li><li><a class="toctext" href="#Non-local-mixing-length-1">Non-local mixing length</a></li><li class="toplevel"><a class="toctext" href="#Boundary-Conditions-1">Boundary Conditions</a></li><li><a class="toctext" href="#BC-functions-1">BC functions</a></li><li><a class="toctext" href="#Area-fraction-1">Area fraction</a></li><li><a class="toctext" href="#st-order-moments-1">1st order moments</a></li><li><a class="toctext" href="#nd-order-moments-1">2nd order moments</a></li><li><a class="toctext" href="#Case-specific-configurations-1">Case-specific configurations</a></li></ul></li></ul></li><li><a class="toctext" href="../../ODESolvers/">ODESolvers</a></li><li><a class="toctext" href="../../Mesh/">Mesh</a></li><li><a class="toctext" href="../../Arrays/">Arrays</a></li><li><a class="toctext" href="../../DGmethods/">DGmethods</a></li><li><a class="toctext" href="../../InputOutput/">InputOutput</a></li><li><span class="toctext">Developer docs</span><ul><li><a class="toctext" href="../../CodingConventions/">Coding Conventions</a></li><li><a class="toctext" href="../../AcceptableUnicode/">Acceptable Unicode characters</a></li><li><a class="toctext" href="../../VariableList/">CliMA Variable List</a></li></ul></li><li><span class="toctext">Balance Law Examples</span><ul><li><a class="toctext" href="../../BalanceLawOverview/">DG Balance Law Method</a></li><li><a class="toctext" href="../../examples/DGmethods/generated/ex_001_periodic_advection/">Example 001: Periodic Advection</a></li><li><a class="toctext" href="../../examples/DGmethods/generated/ex_002_solid_body_rotation/">Example 002: Solid Body Rotation</a></li></ul></li></ul></nav><article id="docs"><header><nav><ul><li>Atmos</li><li><a href>Eddy-Diffusivity Mass-Flux (EDMF) equations</a></li></ul><a class="edit-page" href="https://github.com/climate-machine/CLIMA/blob/master/docs/src/Atmos/EDMFEquations.md"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>Eddy-Diffusivity Mass-Flux (EDMF) equations</span><a class="fa fa-bars" href="#"></a></div></header><div>\[\newcommand{\paramT}[1]{     \textcolor{blue}{  \text{#1}}}
\newcommand{\hyperparamT}[1]{\textcolor{orange}{\text{#1}}}
\newcommand{\simparamT}[1]{  \textcolor{purple}{\text{#1}}}

\newcommand{\exp}[1]{\mathrm{exp}\left(#1\right)}
\newcommand{\atan}[1]{\mathrm{atan}\left(#1\right)}
\newcommand{\sign}[1]{\mathrm{sign}\left(#1\right)}
\newcommand{\erf}[1]{\mathrm{erf}\left(#1\right)}
\newcommand{\erfinv}[1]{\mathrm{erfinv}\left(#1\right)}

\newcommand{\param}[1]{     \textcolor{blue}{  #1}}
\newcommand{\hyperparam}[1]{\textcolor{orange}{#1}}
\newcommand{\simparam}[1]{  \textcolor{purple}{#1}}

\newcommand{\CROSS}{\times}
\newcommand{\GRAD}{\nabla}
\newcommand{\DOT}{\bullet}
\newcommand{\PD}{\partial}
\newcommand{\PDFz}{\frac{\PD}{\PD z}}
\newcommand{\DM}[1]{\langle #1 \rangle}
\newcommand{\iEnv}{e}
\newcommand{\SD}[2]{{\overline{#1}}_{#2}}
\newcommand{\SDi}[1]{{\SD{#1}{i}}}
\newcommand{\SDj}[1]{{\SD{#1}{j}}}
\newcommand{\SDe}[1]{{\SD{#1}{\iEnv}}}
\newcommand{\SDiog}[2]{#1_{#2}}
\newcommand{\SDio}[1]{{\SDiog{#1}{i}}}
\newcommand{\SDjo}[1]{{\SDiog{#1}{j}}}
\newcommand{\SDeo}[1]{{\SDiog{#1}{\iEnv}}}
\newcommand{\aSD}[2]{{#1}_{#2}}
\newcommand{\aSDi}[1]{\aSD{#1}{i}}
\newcommand{\aSDj}[1]{\aSD{#1}{j}}
\newcommand{\aSDe}[1]{\aSD{#1}{\iEnv}}
\newcommand{\otherDefs}{where additional variable definitions are in:}

\newcommand{\IntraCVSDi}[2]{\overline{{#1}_{i      }&#39;{#2}_{i      }&#39;}}
\newcommand{\IntraCVSDj}[2]{\overline{{#1}_{j      }&#39;{#2}_{j      }&#39;}}
\newcommand{\IntraCVSDe}[2]{\overline{{#1}_{\iEnv{}}&#39;{#2}_{\iEnv{}}&#39;}}

\newcommand{\InterCVSDi}[2]{\overline{{#1}_{i      }&#39;}~\overline{{#2}_{i      }&#39;}}
\newcommand{\InterCVSDj}[2]{\overline{{#1}_{j      }&#39;}~\overline{{#2}_{j      }&#39;}}
\newcommand{\InterCVSDe}[2]{\overline{{#1}_{\iEnv{}}&#39;}~\overline{{#2}_{\iEnv{}}&#39;}}

\newcommand{\TCV}[2]{\langle {#1}^*{#2}^* \rangle}

\newcommand{\BC}[1]{{#1|_{z_{min}}}}
\newcommand{\BCT}[1]{{#1|_{z_{max}}}}
\newcommand{\BCB}[1]{{#1|_{z_{min}}}}
\newcommand{\BCG}[1]{{#1|_{z_{boundary}}}}

\newcommand{\Km}{K^m}
\newcommand{\Kh}{K^h}
\newcommand{\TEquilib}{T_{\mathrm{iterated}}}
\newcommand{\PhasePartition}{q}
\newcommand{\ExnerD}{\Pi_{dry}}
\newcommand{\ExnerM}{\Pi_{moist}}
\newcommand{\WindSpeed}{|u|}
\newcommand{\LayerThickness}{\param{\Delta z}}
\newcommand{\SurfaceRoughness}[1]{\param{z_{0#1}}}
\newcommand{\SensibleSurfaceHeatFlux}{F_{\mathrm{sensible}&#39;&#39;}}
\newcommand{\LatentSurfaceHeatFlux}{F_{\mathrm{latent}&#39;&#39;}}
\newcommand{\FrictionVelocity}{u_*}
\newcommand{\Buoyancy}{b}
\newcommand{\BuoyancyGrad}{\PD_z \Buoyancy}
\newcommand{\BuoyancyFlux}{\IntraCVSDi{w}{b}}
\newcommand{\TemperatureScale}{\theta_*}
\newcommand{\SurfaceMomentumFlux}{\BC{\overline{w&#39;u&#39;}}}
\newcommand{\SurfaceHeatFlux}{\BC{\overline{w&#39;\theta&#39;}}}
\newcommand{\SurfaceBuoyancyFlux}{\BC{\IntraCVSDi{w}{\theta}}}
\newcommand{\ConvectiveVelocity}{{w_*}} % Convective velocity near the surface
\newcommand{\InversionHeight}{{z_*}}
\newcommand{\MOLen}{\Lambda_{M-O}}
\newcommand{\zLL}{\param{z_{||}}} % z at the first surface level (we should make this grid-independent)

\newcommand{\qt}{q_{\mathrm{tot}}}
\newcommand{\qr}{q_{\mathrm{rain}}}
\newcommand{\ql}{q_{\mathrm{liq}}}
\newcommand{\qi}{q_{\mathrm{ice}}}
\newcommand{\qv}{q_{\mathrm{vap}}}
\newcommand{\qvsat}{q_{\mathrm{vap}}^*}
\newcommand{\pvsat}{p_{\mathrm{vap}}^*}
\newcommand{\qc}{q_{\mathrm{con}}}
\newcommand{\ThetaVap}{{\theta_{\mathrm{vap}}}}
\newcommand{\ThetaVirt}{{\theta_{\mathrm{virt}}}}
\newcommand{\ThetaRho}{{\theta_{\rho}}}
\newcommand{\ThetaLiq}{{\theta_{\mathrm{liq}}}}
\newcommand{\ThetaLiqIce}{{\theta_{\mathrm{liq-ice}}}}
\newcommand{\ThetaLiqIceSat}{{\theta^*_{\mathrm{liq-ice}}}}
\newcommand{\ThetaDry}{{\theta_{\mathrm{dry}}}}
\newcommand{\TDry}{{T_{dry}}}
\newcommand{\eint}{e_{\mathrm{int}}}
\newcommand{\etot}{e_{\mathrm{tot}}}

\newcommand{\TRef}{{T}_0}
\newcommand{\alphaRef}{{\alpha}_0}
\newcommand{\rhoRef}{{\rho}_0}
\newcommand{\pRef}{{p}_0}
\newcommand{\Heaviside}{\mathcal H}

\newcommand{\alphaLL}{\alphaRef|_{\zLL}}
\newcommand{\uH}{\simparam{\mathbf{u}_h}}

\newcommand{\CoriolisParam}{\hyperparam{\mathrm{coriolis\_param}}}
\newcommand{\SubsidenceParam}{\hyperparam{\mathrm{subsidence}}}
\newcommand{\betaM}{\hyperparam{\beta_m}}
\newcommand{\betaH}{\hyperparam{\beta_h}}
\newcommand{\gammaM}{\hyperparam{\gamma_m}}
\newcommand{\gammaH}{\hyperparam{\gamma_h}}

\newcommand{\PTilde}{\param{\tilde{p}}}
\newcommand{\VKConst}{\param{\kappa_{\mathrm{Von-Karman}}}}
\newcommand{\Nsd}{\hyperparam{N_{sd}}}
\newcommand{\grav}{\param{g}}
\newcommand{\TZero}{\param{T_{0}}}
\newcommand{\RefHintV}{\param{{\eint}_{v,0}}}
\newcommand{\RefHintI}{\param{{\eint}_{i,0}}}

\newcommand{\EpsDV}{\param{\varepsilon_{dv}}}
\newcommand{\EpsVD}{\param{\varepsilon_{vd}}}
\newcommand{\Rm}{R_m}
\newcommand{\Cpm}{c_{pm}}
\newcommand{\Cvm}{c_{vm}}
\newcommand{\Rd}{\param{R_d}}
\newcommand{\Rv}{\param{R_v}}
\newcommand{\Cp}[1]{\param{c_{p#1}}}
\newcommand{\Cv}[1]{\param{c_{v#1}}}
\newcommand{\Cvd}{\Cv{d}}
\newcommand{\Cvv}{\Cv{v}}
\newcommand{\Cvl}{\Cv{l}}
\newcommand{\Cvi}{\Cv{i}}

\newcommand{\DeltaCp}{\param{\Delta c_p}}
\newcommand{\TTriple}{\param{T_{\mathrm{tr}}}}
\newcommand{\PTriple}{\param{p_{\mathrm{tr}}}}
\newcommand{\TFreeze}{\param{T_{\mathrm{freeze}}}}

\newcommand{\RefLHv}{\param{L_{v,0}}}
\newcommand{\RefLHs}{\param{L_{s,0}}}
\newcommand{\RefLHf}{\param{L_{f,0}}}
\newcommand{\LatentHeatV}[1]{L_{vap}(#1)}
\newcommand{\LatentHeatS}[1]{L_{sub}(#1)}
\newcommand{\LatentHeatF}[1]{L_{fus}(#1)}\]</div><h1><a class="nav-anchor" id="Eddy-Diffusivity-Mass-Flux-(EDMF)-equations-1" href="#Eddy-Diffusivity-Mass-Flux-(EDMF)-equations-1">Eddy-Diffusivity Mass-Flux (EDMF) equations</a></h1><p>This document is concerned with defining the set of equations solved in the atmospheric turbulence convection model: the EDMF equations. Color-coding is used to indicate:</p><ul><li><div>\[\paramT{Constant parameters that are fixed in space and time (e.g., those defined in PlanetParameters.jl)}\]</div></li><li><div>\[\simparamT{Single column (SC) inputs (e.g., variables that are fed into the SC model from the dynamical core (e.g., horizontal velocity))}\]</div></li><li><div>\[\hyperparamT{Tunable hyper-parameters that will need to be changeable, but will only include single numbers (e.g., Float64)}\]</div></li></ul><h2><a class="nav-anchor" id="Domain-decomposition-1" href="#Domain-decomposition-1">Domain decomposition</a></h2><p>While our model is 1D along <span>$z$</span> and there is no spatial discretization in the horizontal directions (<span>$x$</span> and <span>$y$</span>), the horizontal space is broken into <span>$\Nsd$</span> (<span>$\sim$</span> 5-10) &quot;bins&quot;, or &quot;subdomains&quot; (SDs), denoted by subscript <span>$i$</span>, where <span>$1 \le i \le \Nsd$</span>. One of the subdomains, the &quot;environment&quot;, is treated different compared to others, termed &quot;updrafts&quot;. This environment subdomain is denoted with a special index <span>$\iEnv{}$</span> (which we usually set to 1). For dummy variables <span>$\phi$</span> and <span>$\psi$</span>, we use several domain and SD representations of interest:</p><div>\[\begin{align}
  \SDi{\phi}                                                                                   \quad &amp; \text{horizontal mean of variable $\phi$ over SD $i$}, \\
  \SDi{\phi}&#39; = \phi_i - \SDi{\phi}                                                            \quad &amp; \text{fluctuations of $\phi$ about the SD mean}, \\
  \IntraCVSDi{\phi}{\psi}                                                                      \quad &amp; \text{intra subdomain covariance}, \\
  \DM{\phi} = \sum_i \aSDi{a} \SDi{\phi}                                                       \quad &amp; \text{horizontal mean of $\phi$ over the total domain}, \\
  \SDi{\phi}^* = \SDi{\phi} - \DM{\phi}                                                        \quad &amp; \text{difference between SD &amp; domain means}, \\
  \InterCVSDi{\phi}{\psi}                                                                      \quad &amp; \text{inter subdomain covariance among SD means}, \\
  \phi^* = \phi - \DM{\phi}                                                                    \quad &amp; \text{difference between SD &amp; domain means}, \\
  \TCV{\phi}{\psi} = \sum_{\forall i} a_i \IntraCVSDi{\phi}{\psi} +
  \sum_{\forall i} \sum_{\forall j}  \aSDi{a} \aSDj{a} \SDi{\phi}(\SDi{\psi} - \SDj{\psi})     \quad &amp; \text{total covariance}.
\end{align}\]</div><p>Here, <span>$\SDi{\phi}$</span> and <span>$\SDi{\psi}$</span> are a dummy variables for the following 7 unknowns:</p><div>\[\begin{align}
  \SDi{w}                   &amp; \quad \text{vertical velocity}, \\
  \SDi{\eint}               &amp; \quad \text{internal energy},  \\
  \SDi{\qt}                 &amp; \quad \text{total water specific humidity},  \\
  \SDi{TKE}                 &amp; \quad \text{turbulent kinetic energy ($0.5(\IntraCVSDi{u}{u}+\IntraCVSDi{v}{v}+\IntraCVSDi{w}{w})$)},  \\
  \IntraCVSDi{\eint}{\eint} &amp; \quad \text{intra subdomain covariance of $\eint&#39;$ and $\eint&#39;$},  \\
  \IntraCVSDi{\qt}{\qt}     &amp; \quad \text{intra subdomain covariance of $\qt&#39;$ and $\qt&#39;$}, \\
  \IntraCVSDi{\eint}{\qt}   &amp; \quad \text{intra subdomain covariance of $\eint&#39;$ and $\qt&#39;$}.
\end{align}\]</div><p>From the large-scale model perspective, <span>$\DM{\phi}$</span> represents the resolved grid-scale (GS) mean, and <span>$\TCV{\phi}{\psi}$</span> represents the SGS fluxes and (co)-variances of scalars that need to be parameterized. Equations in the following sections, \eqref{eq:AreaFracGov}, \eqref{eq:1stMoment} and \eqref{eq:2ndMoment}, are solved on <span>$z_{min} \le z \le z_{max}$</span> and <span>$t \ge 0$</span>. There are <span>$8 \Nsd$</span> equations in total.</p><h2><a class="nav-anchor" id="Domain-averaged-equations-1" href="#Domain-averaged-equations-1">Domain averaged equations</a></h2><p>The EDMF model can be used in the context of a stand-alone single column, or integrated with a dynamical core. Either way, the EDMF model relies on domain-averaged variables, which may be prescribed or solved for. Taking an area fraction-weighted average of the SD equations yields the domain-averaged equations (which should be consistent with variables in the dynamical core).</p><p>The domain-averaged equations for <span>$\DM{\phi} \in [w, \qt, \eint, \uH]$</span> are:</p><div>\[\begin{align}
\PD_t (\rhoRef{} \DM{\phi})
+ \PD_z (\rhoRef{} \DM{w} \DM{\phi})
+ \nabla_h \DOT \left( \rhoRef{} \DM{\phi} \otimes \DM{\phi} \right)
= \\
  \DM{S}_{\text{diff}}^{\DM{\phi}}
+ \DM{S}_{\text{press}}
+ \DM{S}_{\text{coriolis}}
+ \DM{S}_{\text{subsidence}},
\end{align}\]</div><p>where</p><div>\[\begin{align}
\DM{S}_{\text{diff}}^{\DM{\phi}} &amp; = \PD_z (\rhoRef{} \aSDe{a} \SDe{\Km} \PD_z \DM{\phi}),   \label{eq:gm_diffusion} \\
\DM{S}_{\text{diff}}^{w}         &amp; = \PD_z (\rhoRef{} \aSDe{a} \SDe{\Km} \PD_z \DM{w})   ,   \label{eq:gm_diffusion_w} \\
\DM{S}_{\text{press}}            &amp; = - \GRAD_h \DM{p},                                       \label{eq:gm_pressure} \\
\DM{S}_{\text{coriolis}}         &amp; = \CoriolisParam \DM{\phi} \CROSS \mathbf{k},             \label{eq:gm_coriolis} \\
\DM{S}_{\text{subsidence}}       &amp; = - \SubsidenceParam \GRAD \phi,                          \label{eq:gm_subsidence} \\
\end{align}\]</div><h2><a class="nav-anchor" id="Sub-domain-equations:-Area-fraction-1" href="#Sub-domain-equations:-Area-fraction-1">Sub-domain equations: Area fraction</a></h2><p>The EDMF equations take the form of advection-diffusion equations. The size of these SDs are tracked by solving an equation governing the area fraction in the <span>$i$</span>th SD (<span>$\aSDi{a}$</span>), given by:</p><div>\[\begin{gather}
  \PD_t (\rhoRef{} \aSDi{a})
  + \PD_z (\rhoRef{} \aSDi{a} \SDi{w})
  + \GRAD_h \DOT
  (\rhoRef{} \aSDi{a} \DM{\uH})
  =
  \SDi{S}^a
  , \quad i \ne \iEnv, \label{eq:AreaFracGov} \\
  \aSDi{a} = 1 - \sum_{j\ne\iEnv} \aSDj{a}, \quad i = \iEnv, \label{eq:AreaFracConserve} \\
  \qquad 0 &lt; \aSDi{a} &lt; 1. \label{eq:AreaFracConstraint}
\end{gather}\]</div><p>Here, <span>$\rhoRef{}, \SDi{w}, \uH$</span> is fluid density, mean vertical velocity along <span>$z$</span>, and domain-mean of the horizontal velocity respectively. The area fraction constraints are necessary to ensure the system of equations is well-posed. All source terms (<span>$\SDi{S}^a$</span>) will be discussed in later sections.</p><div class="admonition note"><div class="admonition-title">Note</div><div class="admonition-text"><p>The greater than zero constraint must be satisfied at every step of the solution process, since it is necessary to avoid division by zero in the mean field equations.</p></div></div><div>\[\begin{align}
\SDi{S}^a = \SDi{S_{\epsilon\delta}}^a.
\end{align}\]</div><h3><a class="nav-anchor" id="Source-term-definitions-1" href="#Source-term-definitions-1">Source term definitions</a></h3><p>We note that the net exchange is zero <span>$\sum_i \SDi{S_{\epsilon\delta}}^a = 0$</span>. Therefore, we may define the environment source term as the negative sum of all updraft source terms. The entrainment-detrainment source is:</p><div>\[\begin{align}
\SDi{S_{\epsilon\delta}}^a =
\begin{cases}
  \rho a_i \SDi{w} \left( -\delta_i + \epsilon_{i} \right) &amp; i \ne \iEnv{} \\
  0 - \sum_{j \ne \iEnv{}} \SDj{S_{\epsilon\delta}}^a &amp; i = \iEnv{} \\
\end{cases},
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><p><a href="#Reference-state-profiles-1">Reference state profiles</a> (<span>$\pRef{}$</span>, <span>$\rhoRef{}$</span>, and <span>$\alphaRef{}$</span>).</p></li><li><p><a href="#Entrainment-Detrainment-1">Entrainment-Detrainment</a> (<span>$\epsilon_{i}$</span>) and (<span>$\delta_i$</span>).</p></li></ul><h2><a class="nav-anchor" id="Sub-domain-equations:-1st-moment-1" href="#Sub-domain-equations:-1st-moment-1">Sub-domain equations: 1st moment</a></h2><p>The 1st moment sub-domain equations are:</p><div>\[\begin{align}\label{eq:1stMoment}
  \PD_t (\rhoRef{} \aSDi{a} \SDi{\phi})
  + \PD_z (\rhoRef{} \aSDi{a} \SDi{w} \SDi{\phi})
  + \GRAD_h \DOT
  (\rhoRef{} \aSDi{a} \DM{\uH} \SDi{\phi})
  =
  \SDi{S}^\phi
  , \quad \forall i. \\
\end{align}\]</div><p>Here, <span>$\SDi{S}^{\phi}$</span> are source terms, including diffusion, and many other sub-grid-scale (SGS) physics. In general, <span>$\SDi{S}^{\phi}$</span> and <span>$\SDi{S}^{a}$</span> may depend on <span>$\SDj{\phi}$</span> and or <span>$\aSDj{a}$</span> for any <span>$j$</span>.</p><h3><a class="nav-anchor" id="Source-terms-per-equation-1" href="#Source-terms-per-equation-1">Source terms per equation</a></h3><p>The source terms common to all unknowns are:</p><div>\[\begin{align}
\SDi{S}^{\phi} =
  \SDi{S_{\epsilon\delta}}^{\phi}
+ \SDi{S_{\text{turb-transp}}}^{\phi}, \quad \forall \phi
\end{align}\]</div><p>Additional source terms exist in other equations:</p><div>\[\begin{align}
\SDi{S}^{w} &amp;=
  \SDi{S_{\epsilon\delta}}^w
+ \SDi{S_{\text{turb-transp}}}^w
+ \SDi{S_{\text{buoy}}}
+ \SDi{S_{\text{nh-press}}}
+ \SDi{S_{\text{coriolis}}}, \\
\SDi{S}^{\eint} &amp;=
  \SDi{S_{\epsilon\delta}}^{\eint}
+ \SDi{S_{\text{turb-transp}}}^{\eint}
+ \SDi{S_{\text{MP-MSS}}}^{\eint}
+ \SDi{S_{\text{rad}}}, \\
\SDi{S}^{\qt} &amp;=
  \SDi{S_{\epsilon\delta}}^{\qt}
+ \SDi{S_{\text{turb-transp}}}^{\qt}
+ \SDi{S_{\text{MP-MSS}}}^{\qt}.
\end{align}\]</div><h3><a class="nav-anchor" id="Source-term-definitions-2" href="#Source-term-definitions-2">Source term definitions</a></h3><p>Note: The sum of the total pressure and gravity are recast into the sum of the non-hydrostatic pressure and buoyancy sources.</p><div>\[\begin{align}
\SDi{S_{\epsilon\delta}}^{\phi} &amp;=
\begin{cases}
  \rhoRef{} a_i \SDi{w} \left( -\delta_i \SDi{\phi} + \epsilon_{i} \SDe{\phi} \right) &amp; i \ne \iEnv{} \\
  0 - \sum_{j \ne \iEnv{}} \SDj{S_{\epsilon\delta}}^{\phi} &amp; i=\iEnv{} \\
\end{cases} \\
\SDi{S_{\text{turb-transp}}}^{\phi} &amp; =  -\PD_z (\rhoRef{} a_i \IntraCVSDi{w}{\phi}) \\
 &amp; = \PD_z (\rhoRef{} a_i \SDi{\Km} \PD_z \SDi{\phi}) \\
\SDi{S_{\text{nh-press}}} &amp;= -\rhoRef{} \aSDi{a} \left( \alpha_b \SDi{b}  + \alpha_d \frac{(\SDi{w} - \SDe{w}) | \SDi{w} - \SDe{w} | }{r_d \aSDi{a}^{1/2}} \right) \\
\alpha_b &amp;= 1/3, \quad \alpha_d = 0.375, \quad r_d      = 500 [m] \\
\SDi{S_{\text{buoy}}} &amp;= \rhoRef{} \aSDi{a} \SDi{b} \\
\SDi{S_{\text{coriolis}}} &amp; = f(\SDi{\mathbf{u}} - {\SDi{\mathbf{u}_{\text{geo-wind}}}}) \\
\SDi{S_{\text{rad}}}  &amp;= \left( \PD_t {\SDi{\eint}} \right)_{radiation} \\
\SDi{S_{\text{MP-MSS}}}^{\qt} &amp; = \\
\SDi{S_{\text{MP-MSS}}}^{\eint} &amp; = \\
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><p><a href="#Reference-state-profiles-1">Reference state profiles</a> (<span>$\pRef{}$</span>, <span>$\rhoRef{}$</span>, and <span>$\alphaRef{}$</span>).</p></li><li><p><a href="#Entrainment-Detrainment-1">Entrainment-Detrainment</a> (<span>$\epsilon_{i}$</span>) and (<span>$\delta_i$</span>).</p></li><li><p><a href="#Buoyancy-1">Buoyancy</a> (<span>$\Buoyancy$</span>).</p></li><li><p><a href="#Eddy-diffusivity-1">Eddy diffusivity</a> (<span>$\Km, \Kh$</span>).</p></li></ul><h2><a class="nav-anchor" id="Sub-domain-equations:-2nd-moment-1" href="#Sub-domain-equations:-2nd-moment-1">Sub-domain equations: 2nd moment</a></h2><p>The 2nd moment sub-domain equations are of the exact same form as the 1st moment equations (equation \eqref{eq:1stMoment}):</p><div>\[\begin{align}\label{eq:2ndMoment}
  \PD_t (\rhoRef{} \aSDi{a} \SDi{\phi})
  + \PD_z (\rhoRef{} \aSDi{a} \SDi{w} \SDi{\phi})
  + \GRAD_h \DOT
  (\rhoRef{} \aSDi{a} \DM{\uH} \SDi{\phi})
  =
  \SDi{S}^\phi
  , \quad \forall i. \\
\end{align}\]</div><p>Here, <span>$\SDi{S}^{\phi}$</span> are source terms, including diffusion, and many other sub-grid-scale (SGS) physics. In general, <span>$\SDi{S}^{\phi}$</span> and <span>$\SDi{S}^{a}$</span> may depend on <span>$\SDj{\phi}$</span> and or <span>$\aSDj{a}$</span> for any <span>$j$</span>.</p><h3><a class="nav-anchor" id="Source-terms-per-equation-2" href="#Source-terms-per-equation-2">Source terms per equation</a></h3><p>The source terms common to all unknowns are:</p><div>\[\begin{align}
\SDi{S}^{\phi\psi} =
  \SDi{S_{\epsilon\delta}}^{\phi\psi}
+ \SDi{S_{\text{x-grad flux}}}^{\phi\psi}
+ \SDi{S_{\text{turb-transp}}}^{\phi\psi}
\quad \forall \phi \psi,
\end{align}\]</div><p>Additional source terms exist in other equations:</p><div>\[\begin{align}
\SDi{S}^{TKE} &amp;=
  \SDi{S_{\epsilon\delta}}^{TKE}
+ \SDi{S_{\text{x-grad flux}}}^{TKE}
+ \SDi{S_{\text{turb-transp}}}^{TKE}
+ \SDi{S_{\text{dissip}}}
+ \SDi{S_{\text{press}}},
+ \SDi{S_{\text{buoyancy}}}, \\
\SDi{S}^{\phi\psi} &amp;=
  \SDi{S_{\epsilon\delta}}^{\phi\psi}
+ \SDi{S_{\text{x-grad flux}}}^{\phi\psi}
+ \SDi{S_{\text{turb-transp}}}^{\phi\psi}
+ \SDi{S_{\text{MP-MSS}}}^{\phi\psi}.
\quad \phi\psi \in [\qt\qt, \eint\eint, \eint \qt].
\end{align}\]</div><h3><a class="nav-anchor" id="Source-term-definitions-3" href="#Source-term-definitions-3">Source term definitions</a></h3><div>\[\begin{align}
\SDi{S_{\epsilon\delta}}^{\phi\psi} &amp;=
\begin{cases}
  \rhoRef{} a_i \SDi{w} \left[ -\delta_i \IntraCVSDi{\phi}{\psi} + \epsilon_{i}
\left(
\IntraCVSDe{\phi}{\psi} + (\SDe{\phi} - \SDi{\phi})(\SDe{\psi} - \SDi{\psi})
\right) \right] &amp; i \ne \iEnv \\
  0 - \sum_{j\ne \iEnv} \SDj{S_{\epsilon\delta}}^{\phi\psi} &amp; i=\iEnv \\
\end{cases} \\
\SDi{S_{\epsilon\delta}}^{TKE} &amp;=
\begin{cases}
  \rhoRef{} a_i \SDi{w} \left[ -\delta_i \SDi{TKE} + \epsilon_{i}
\left(
\SDe{TKE} + \frac{1}{2} (\SDe{w} - \SDi{w})^2
\right) \right] &amp; i \ne \iEnv \\
  0 - \sum_{j\ne \iEnv} \SDj{S_{\epsilon\delta}}^{TKE} &amp; i=\iEnv \\
\end{cases} \\
\SDi{S_{\text{x-grad flux}}}^{\phi\psi}
&amp; =
- \rhoRef{} a_i \IntraCVSDi{w}{\psi} \PD_z \SDi{\phi}
- \rhoRef{} a_i \IntraCVSDi{w}{\phi} \PD_z \SDi{\psi} \\
&amp; =
 2 \rhoRef{} a_i \SDi{\Kh} \PD_z \SDi{\psi} \PD_z \SDi{\phi} \\
\SDi{S_{\text{x-grad flux}}}^{TKE}
&amp; =
\rhoRef{} a_i \SDi{\Km} \left[ \left(\PD_z\DM{u}\right)^2 + \left(\PD_z\DM{v}\right)^2 + \left(\PD_z\DM{w}\right)^2 \right] \\
\SDi{S_{\text{turb-transp}}}^{\phi\psi} &amp; = - \PD_z (\rhoRef{} a_i \overline{w&#39;_i\phi&#39;_i\psi&#39;_i}) \\
&amp; = \PD_z (\rhoRef{} a_i \SDi{\Kh} \PD_z \IntraCVSDi{\phi}{\psi}) \\
\SDi{S_{\text{turb-transp}}}^{TKE} &amp; = \PD_z (\rhoRef{} a_i \SDi{\Km} \PD_z \SDi{TKE}) \\
\SDi{S_{\text{dissip}}}
&amp; = - \rhoRef{} a_i c_e \IntraCVSDi{\phi}{\psi} \frac{\SDi{TKE}^{1/2}}{\SDio{{l_{mix}}}}, \quad \text{Equation 38 in Tan et al.} \\
c_e &amp; = 2 \\
\SDi{S_{\text{press}}}
&amp; = - \aSDi{a} \left[ \IntraCVSDi{u}{(\partial_x p^{\dagger})} +
                      \IntraCVSDi{v}{(\partial_y p^{\dagger})} +
                      \IntraCVSDi{w}{(\partial_z p^{\dagger})}\right]  \\
&amp; = 0, \qquad \text{for now, need to derive correct formulation} \\
\SDi{S_{\text{buoyancy}}}^{TKE} &amp; = \rhoRef{} \aSDi{a} \BuoyancyFlux \\
\SDi{S_{\text{MP-MSSP}}}^{\qt\qt}
&amp; = \\
\SDi{S_{\text{MP-MSSP}}}^{\eint\eint}
&amp; = \\
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><p><a href="#Reference-state-profiles-1">Reference state profiles</a> (<span>$\pRef{}$</span>, <span>$\rhoRef{}$</span>, and <span>$\alphaRef{}$</span>).</p></li><li><p><a href="#Entrainment-Detrainment-1">Entrainment-Detrainment</a> (<span>$\epsilon_{i}$</span>) and (<span>$\delta_i$</span>).</p></li><li><p><a href="#Eddy-diffusivity-1">Eddy diffusivity</a> (<span>$\Km, \Kh$</span>).</p></li><li><p><a href="#Mixing-length-1">Mixing length</a> (<span>$l_{mix}$</span>).</p></li><li><p><a href="#Buoyancy-flux-1">Buoyancy flux</a> (<span>$\BuoyancyFlux$</span>).</p></li></ul><h1><a class="nav-anchor" id="EDMF-variable-definitions-1" href="#EDMF-variable-definitions-1">EDMF variable definitions</a></h1><p>The following definitions are ordered in a dependency fashion; all variables are defined from variables already defined in previous subsections.</p><h2><a class="nav-anchor" id="Constants-1" href="#Constants-1">Constants</a></h2><div>\[\begin{align}
c_K &amp; = 0.1 \\
\text{tol}_{\InversionHeight\mathrm{-stable}} &amp; = 0.01 \\
\end{align}\]</div><h2><a class="nav-anchor" id="Phase-partition-1" href="#Phase-partition-1">Phase partition</a></h2><div>\[\begin{align}
\PhasePartition &amp;= \{\qv, \ql, \qi\} \\
\qv &amp;= \qt - \ql - \qi \\
\pvsat(T) &amp;= \PTriple \left( \frac{T}{\TTriple} \right)^{\frac{\DeltaCp}{\Rv}} \exp{\frac{\RefLHv - \DeltaCp \TZero}{\Rv} \left( \frac{1}{\TTriple} - \frac{1}{T} \right)} \label{eq:pvsat} \\
\qvsat(T, \rho) &amp;= \frac{\pvsat(T)}{\rho \Rv T}                                                                                                                            \label{eq:qvsat} \\
\qc &amp;= \max(\qt - \qvsat, 0)                                                                                                                                               \label{eq:qc} \\
\ql &amp;= \lambda \qc                                                                                                                                                         \label{eq:ql} \\
\qi &amp;= (1-\lambda) \qc                                                                                                                                                     \label{eq:qi} \\
\lambda(T) &amp;= \Heaviside(T-\TFreeze)                                                                                                                                       \label{eq:lambda} \\
\Heaviside &amp;= \text{Heaviside function} \\
\end{align}\]</div><p>Functionally,</p><div>\[\begin{align}
\PhasePartition &amp; = \PhasePartition(\qt, T, \rho) \\
\qvsat &amp; = \qvsat(T, \rho) \\
\end{align}\]</div><h2><a class="nav-anchor" id="Gas-constants-1" href="#Gas-constants-1">Gas constants</a></h2><div>\[\begin{align}
\EpsDV &amp; = \frac{\Rv}{\Rd} \approx 1.61 \\
\EpsVD &amp; = \frac{\Rd}{\Rv} \approx 0.62 \\
\Rm &amp; = \Rd \left[1 + (\EpsDV-1) \qt - \EpsDV (\ql+\qi) \right] \\
\end{align}\]</div><h2><a class="nav-anchor" id="Specific-heats-1" href="#Specific-heats-1">Specific heats</a></h2><div>\[\begin{align}
\Cvm &amp;= (1 - \SDi{\qt}) \Cv{d} + \SDi{\qv} \Cv{v} + \SDi{\ql} \Cv{l} + \SDi{\qi} \Cv{i} \\
\Cpm &amp;= (1 - \SDi{\qt}) \Cp{d} + \SDi{\qt} \Cp{v} \\
\end{align}\]</div><h2><a class="nav-anchor" id="Latent-heat-1" href="#Latent-heat-1">Latent heat</a></h2><div>\[\begin{align}
\LatentHeatV{T} &amp;= \RefLHv + \Cp{v} - \Cp{l} (T - \TTriple) \\
\end{align}\]</div><h2><a class="nav-anchor" id="Exner-functions-1" href="#Exner-functions-1">Exner functions</a></h2><div>\[\begin{align}
\ExnerD(\pRef{})    = \left(\frac{\pRef{}}{\PTilde{}} \right)^{\Rd/\Cp{d}} \\
\ExnerM(\pRef{}, \PhasePartition) = \left(\frac{\pRef{}}{\PTilde{}} \right)^{\Rm/\Cpm} \\
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><p><a href="#Specific-heats-1">Specific heats</a> <span>$\Cpm$</span> and <span>$\Cvm$</span>.</p></li><li><p><a href="#Gas-constants-1">Gas constants</a> (<span>$\Rm$</span>).</p></li><li><p><a href="#Phase-partition-1">Phase partition</a> <span>$\PhasePartition, \qt, \qv, \ql, \qi, \qvsat$</span>.</p></li></ul><h2><a class="nav-anchor" id="Temperature-1" href="#Temperature-1">Temperature</a></h2><p>Note that, while temperature may be computed using different thermodynamic formulations, <a href="../../Utilities/MoistThermodynamics/#CLIMA.MoistThermodynamics.ThermodynamicState"><code>ThermodynamicState</code></a>&#39;s are immediately converted to the (<span>$\qt, \eint, \rhoRef{}$</span>)-formulation.</p><h3><a class="nav-anchor" id="Dry-temperature-1" href="#Dry-temperature-1">Dry temperature</a></h3><div>\[\begin{align}
\TDry &amp; = \ThetaLiqIce \ExnerD \\
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><a href="#Exner-functions-1">Exner functions</a> <span>$\ExnerD$</span> and <span>$\ExnerM$</span>.</li></ul><p>Functionally,</p><div>\[\begin{align}
\TDry &amp; = \TDry(\ThetaLiqIce, \pRef) \\
\end{align}\]</div><h3><a class="nav-anchor" id="(\\qt,-\\eint,-\\rhoRef{})-formulation-1" href="#(\\qt,-\\eint,-\\rhoRef{})-formulation-1">(<span>$\qt, \eint, \rhoRef{}$</span>)-formulation</a></h3><p>Here, <span>$T$</span> conditionally satisfies the non-linear set of equations, which can be solved using a standard root solver (e.g., Secant method):</p><div>\[\begin{align}
T =
\begin{cases}
\mathrm{satisfies} &amp; \eint(T) = \Cvm (T - \TZero)  + \qv \RefHintV - \qi \RefHintI &amp; \qt &gt; \qvsat(T, \rhoRef{}) \\
&amp; \TZero + \frac{\eint(T)}{(1-\qt)\Cv{d} + \qt \Cv{v}} + \qt \RefHintV &amp; \text{otherwise} \\
\end{cases}
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><p><a href="#Phase-partition-1">Phase partition</a> <span>$\PhasePartition, \qt, \qv, \ql, \qi, \qvsat$</span>.</p></li><li><p><a href="#Specific-heats-1">Specific heats</a> <span>$\Cpm$</span> and <span>$\Cvm$</span>.</p></li><li><p><a href="#Reference-state-profiles-1">Reference state profiles</a> (<span>$\pRef{}$</span>, <span>$\rhoRef{}$</span>, and <span>$\alphaRef{}$</span>).</p></li></ul><p>Functionally,</p><div>\[\begin{align}
T &amp; = T(\qt, \eint, \rhoRef) \\
\end{align}\]</div><h3><a class="nav-anchor" id="(\\qt,-\\ThetaLiqIce,-\\rhoRef,-\\pRef)-formulation-1" href="#(\\qt,-\\ThetaLiqIce,-\\rhoRef,-\\pRef)-formulation-1">(<span>$\qt, \ThetaLiqIce, \rhoRef, \pRef$</span>)-formulation</a></h3><p>Here, <span>$T$</span> conditionally satisfies the non-linear set of equations, which can be solved using a standard root solver (e.g., Secant method):</p><div>\[\begin{align}
T =
\begin{cases}
\mathrm{satisfies} &amp; \ThetaLiqIce \ExnerM = T \left(1 - \frac{ \RefLHv \ql + \RefLHs \qi}{\Cpm T} \right) &amp; \qt &gt; \qvsat(T, \rhoRef{}) \\
&amp; \TDry &amp; \text{otherwise} \\
\end{cases}
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><p><a href="#Dry-temperature-1">Dry temperature</a> <span>$\TDry$</span>.</p></li><li><p><a href="#Phase-partition-1">Phase partition</a> <span>$\PhasePartition, \qt, \qv, \ql, \qi, \qvsat$</span>.</p></li><li><p><a href="#Specific-heats-1">Specific heats</a> <span>$\Cpm$</span> and <span>$\Cvm$</span>.</p></li><li><p><a href="#Exner-functions-1">Exner functions</a> <span>$\ExnerD$</span> and <span>$\ExnerM$</span>.</p></li></ul><p>Functionally,</p><div>\[\begin{align}
T &amp; = T(\qt, \ThetaLiqIce, \rhoRef, \pRef) \\
\end{align}\]</div><h2><a class="nav-anchor" id="Reference-state-profiles-1" href="#Reference-state-profiles-1">Reference state profiles</a></h2><p>Using the hydrostatic balance, <span>$\PD_z \pRef = - \rhoRef{} \grav$</span>, and the ideal gas law, <span>$\pRef = \rhoRef{} \Rm \TRef$</span>, the reference state profiles are computed as:</p><div>\[\begin{align}
\PD_z \pRef &amp; = - \grav \frac{\pRef}{\TRef \Rm} \\
\int_{\BC{\pRef}}^{\pRef} \frac{\TDry(\BC{\DM{\ThetaLiqIce}}, \pRef)}{\pRef} \PD \pRef &amp; = - \frac{\grav}{\BC{\DM{\Rm}}} \int_{z_{min}}^{z} \PD z \\
\rhoRef{}(\pRef) &amp; = \frac{\pRef{}}{\TDry(\BC{\DM{\ThetaLiqIce}}, \pRef) \BC{\DM{\Rm}}} \\
\alphaRef &amp; = \frac{1}{\rhoRef{}(\pRef)} \\
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><p><a href="#Temperature-1">Temperature</a> (<span>$T$</span> and <span>$\TDry$</span>).</p></li><li><p><a href="#Gas-constants-1">Gas constants</a> (<span>$\Rm$</span>).</p></li><li><p><a href="#Specific-heats-1">Specific heats</a> <span>$\Cpm$</span> and <span>$\Cvm$</span>.</p></li></ul><h2><a class="nav-anchor" id="Mixing-ratios-1" href="#Mixing-ratios-1">Mixing ratios</a></h2><div>\[\begin{align}\label{eq:MixingRatios}
r_{con} &amp; = \frac{\qt+\ql}{1 - \qt} \\
r_{vap} &amp; = \frac{\qt-\ql    - \qi}{1 - \qt} \\
\end{align}\]</div><h2><a class="nav-anchor" id="Potential-temperatures-1" href="#Potential-temperatures-1">Potential temperatures</a></h2><p>Fix: which virtual potential temperature is used</p><div>\[\begin{align}\label{eq:Theta}
\ThetaDry    &amp; = T/\ExnerD \\
\ThetaLiqIce &amp; = \ThetaDry (1 - (\RefLHv \ql + \RefLHs \qi))/(\Cpm T) \\
\ThetaVirt   &amp; = \ThetaDry (1 - r_{con} + 0.61 r_{vap}) \\
\ThetaVirt   &amp; = \theta \left(1 + 0.61 \qr - \ql \right) \\
\ThetaRho    &amp; = T \Rm/\ExnerD \\
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><p><a href="#Reference-state-profiles-1">Reference state profiles</a> (<span>$\pRef{}$</span>, <span>$\rhoRef{}$</span>, and <span>$\alphaRef{}$</span>).</p></li><li><p><a href="#Exner-functions-1">Exner functions</a> (<span>$\ExnerM$</span>).</p></li><li><p><a href="#Mixing-ratios-1">Mixing ratios</a> (<span>$r_{con}$</span>, <span>$r_{vap}$</span>).</p></li></ul><h2><a class="nav-anchor" id="Shear-production-1" href="#Shear-production-1">Shear production</a></h2><div>\[\begin{align}\label{eq:ShearProduction}
|S|^2 &amp;= (\PD_z \DM{u})^2 + (\PD_z \DM{v})^2 + (\PD_z \SDe{w})^2 \\
\end{align}\]</div><h2><a class="nav-anchor" id="Buoyancy-1" href="#Buoyancy-1">Buoyancy</a></h2><div>\[\begin{align}\label{eq:Buoyancy}
\SDi{b}^{\dagger} &amp; = \grav (\SDi{\alpha} - \alphaRef)/\alphaRef \\
\SDi{b} &amp; = \SDi{b}^{\dagger} - \sum_j a_j \SDj{b}^{\dagger} \\
\alpha_i &amp; = \frac{\SDi{\Rm} \SDi{T}}{\pRef} \\
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><p><a href="#Reference-state-profiles-1">Reference state profiles</a> (<span>$\pRef{}$</span>, <span>$\rhoRef{}$</span>, and <span>$\alphaRef{}$</span>).</p></li><li><p><a href="#Phase-partition-1">Phase partition</a> <span>$\PhasePartition, \qt, \qv, \ql, \qi, \qvsat$</span>.</p></li><li><p><a href="#Temperature-1">Temperature</a> (<span>$T$</span> and <span>$\TDry$</span>).</p></li></ul><h2><a class="nav-anchor" id="Buoyancy-gradient-1" href="#Buoyancy-gradient-1">Buoyancy gradient</a></h2><h3><a class="nav-anchor" id="(\\qt,-\\ThetaLiqIce,-\\pRef,-\\rhoRef)-formulation-1" href="#(\\qt,-\\ThetaLiqIce,-\\pRef,-\\rhoRef)-formulation-1">(<span>$\qt, \ThetaLiqIce, \pRef, \rhoRef$</span>)-formulation</a></h3><div>\[\begin{align}\label{eq:BuoyancyGradLong}
\SDi{\BuoyancyGrad} &amp; = \PD_z \SDi{\ThetaLiqIce}
\left[ (1-f_c) \PD_{\ThetaLiqIce} b |_d  + f_c \PD_{\ThetaLiqIce} b |_s \right] +
\PD_z \SDi{\qt}      \left[ (1-f_c) \PD_{\qt} b |_d + f_c \PD_{\qt} b |_s \right] \\
f_c &amp;= 0 \qquad \text{good for simple cases, need to confirm for more complex cases} \\
\PD_{\ThetaLiqIce} b |_d &amp; = \frac{\grav}{\DM{\ThetaVirt}} \left[ 1 + \left( \frac{\Rv}{\Rd} - 1 \right) \SDi{\qt} \right] \\
\PD_{\ThetaLiqIce} b |_s &amp;= \frac{\grav}{\DM{\ThetaVirt}} \left[ 1 + \frac{\Rv}{\Rd} \left(1 + \frac{\LatentHeatV{\SDi{T}}}{\Rv \SDi{T}} \right) \SDi{\qvsat} - \SDi{\qt} \right] \left( 1 + \frac{{\LatentHeatV{\SDi{T}}}^2}{\Cpm \Rv \SDi{T}^2} \SDi{\qvsat} \right)^{-1} \\
\PD_{\qt} b |_d &amp;= \frac{\grav}{\DM{\ThetaVirt}} \left( \frac{\Rv}{\Rd} - 1 \right) \SDi{\ThetaDry} \\
\PD_{\qt} b |_s &amp;= \left( \frac{{\LatentHeatV{\SDi{T}}}}{\Cpm \SDi{T}} \PD_{\ThetaLiqIce} b |_s - \frac{\grav}{\DM{\ThetaVirt}} \right) \SDi{\ThetaDry} \\
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><p><a href="#Reference-state-profiles-1">Reference state profiles</a> (<span>$\pRef{}$</span>, <span>$\rhoRef{}$</span>, and <span>$\alphaRef{}$</span>).</p></li><li><p><a href="#Potential-temperatures-1">Potential temperatures</a> (<span>$\ThetaDry$</span>, <span>$\ThetaVirt$</span>).</p></li><li><p><a href="#Phase-partition-1">Phase partition</a> <span>$\PhasePartition, \qt, \qv, \ql, \qi, \qvsat$</span>.</p></li><li><p><a href="#Latent-heat-1">Latent heat</a> (<span>$\LatentHeatV{T}$</span>).</p></li></ul><h3><a class="nav-anchor" id="(\\qt,-\\eint,-\\rhoRef{})-formulation-2" href="#(\\qt,-\\eint,-\\rhoRef{})-formulation-2">(<span>$\qt, \eint, \rhoRef{}$</span>)-formulation</a></h3><p>Pending.</p><h2><a class="nav-anchor" id="Surface-fluxes-1" href="#Surface-fluxes-1">Surface fluxes</a></h2><div class="admonition todo"><div class="admonition-title">Todo</div><div class="admonition-text"><p>Add definitions for universal functions (e.g., <span>$\Psi_m$</span>).</p></div></div><p>Variables in this section must be computed simultaneously because it requires the solution of a non-linear equation.</p><h3><a class="nav-anchor" id="Monin-Obhukov-length-1" href="#Monin-Obhukov-length-1">Monin-Obhukov length</a></h3><p>NOTE: All variables (Monin-Obhukov length, friction velocity, temperature scale) in <a href="#Surface-fluxes-1">Surface fluxes</a> must be solved simultaneously</p><div>\[\begin{align}\label{eq:MOLen}
\MOLen = \begin{cases}
- \frac{\FrictionVelocity^3 \theta}{\VKConst \grav \SurfaceHeatFlux} &amp; \SurfaceHeatFlux &gt; 0 \\
0 &amp; \text{otherwise} \\
\end{cases} \\
\end{align}\]</div><h3><a class="nav-anchor" id="Friction-velocity-1" href="#Friction-velocity-1">Friction velocity</a></h3><p>NOTE: All variables (Monin-Obhukov length, friction velocity, temperature scale) in <a href="#Surface-fluxes-1">Surface fluxes</a> must be solved simultaneously</p><ul><li><p>Knowns: <span>$u_{\mathrm{ave}} = \sqrt{\DM{u}^2+\DM{v}^2}, \LayerThickness, \SurfaceRoughness{m}$</span></p></li><li><p>Unknowns: <span>$\FrictionVelocity, \MOLen$</span>, and <span>$\SurfaceMomentumFlux$</span></p></li></ul><div>\[\begin{align}\label{eq:FrictionVelocity}
u_{\mathrm{ave}}     &amp; = \frac{\FrictionVelocity}{\VKConst}    \left[ \log\left(\frac{\LayerThickness}{\SurfaceRoughness{m}}\right) - \Psi_m\left(\frac{\LayerThickness}{\MOLen}\right) + \frac{\SurfaceRoughness{m}}{\LayerThickness} \Psi_m\left(\frac{\SurfaceRoughness{m}}{\MOLen}\right) + R_{z0m} \left\{ \psi_m\left(\frac{\SurfaceRoughness{m}}{\MOLen}\right) - 1 \right\} \right] \\
R_{z0m}              &amp; = 1 - \SurfaceRoughness{h}/\LayerThickness \\
\SurfaceMomentumFlux &amp; = -\FrictionVelocity^2                , \label{eq:SurfaceMomentumFlux}  \\
\end{align}\]</div><p>where <span>$\Psi_m$</span> is defined in Appendix A, equations A6 in Nishizawa, S., and Y. Kitamura. &quot;A Surface Flux Scheme Based on the Monin‐Obukhov Similarity for Finite Volume Models.&quot; Journal of Advances in Modeling Earth Systems 10.12 (2018): 3159-3175.</p><h3><a class="nav-anchor" id="Temperature-scale-1" href="#Temperature-scale-1">Temperature scale</a></h3><p>NOTE: All variables (Monin-Obhukov length, friction velocity, temperature scale) in <a href="#Surface-fluxes-1">Surface fluxes</a> must be solved simultaneously</p><ul><li><p>Knowns: <span>$\theta_{\mathrm{ave}}, \theta_s, \LayerThickness, \SurfaceRoughness{h}$</span></p></li><li><p>Unknowns: <span>$\FrictionVelocity, \MOLen$</span>, and <span>$\SurfaceHeatFlux$</span></p></li></ul><div>\[\begin{align}\label{eq:TemperatureScale}
\theta_{\mathrm{ave}} - \theta_s &amp; = \frac{Pr \TemperatureScale}{\VKConst} \left[ \log\left(\frac{\LayerThickness}{\SurfaceRoughness{h}}\right) - \Psi_h\left(\frac{\LayerThickness}{\MOLen}\right) + \frac{\SurfaceRoughness{h}}{\LayerThickness} \Psi_m\left(\frac{\SurfaceRoughness{h}}{\MOLen}\right) + R_{z0h} \left\{ \psi_h\left(\frac{\SurfaceRoughness{h}}{\MOLen}\right) - 1 \right\} \right] \\
R_{z0h}                          &amp; = 1 - \SurfaceRoughness{h}/\LayerThickness \\
\SurfaceHeatFlux                 &amp; = -\FrictionVelocity\TemperatureScale , \label{eq:SurfaceHeatFlux}  \\
\end{align}\]</div><p>where <span>$\Psi_h$</span> is defined in Appendix A, equation A6 in Nishizawa, S., and Y. Kitamura. &quot;A Surface Flux Scheme Based on the Monin‐Obukhov Similarity for Finite Volume Models.&quot; Journal of Advances in Modeling Earth Systems 10.12 (2018): 3159-3175.</p><h2><a class="nav-anchor" id="Prandtl-number-1" href="#Prandtl-number-1">Prandtl number</a></h2><div>\[\begin{align}\label{eq:PrandtlNumber}
Pr_{neut} &amp;= 0.74 \\
Pr(z) &amp;= \begin{cases}
    Pr_{neut} &amp; \MOLen &lt; 0 \\
    Pr_{neut} \left[ \frac{1 + \omega_2 R_g - \sqrt{-4 R_g + (1+\omega_2 R_g)^2}}{2 R_g} \right] &amp; \text{otherwise} \\
\end{cases} \\
\omega_2 &amp;= \omega_1+1 \\
\omega_1 &amp;= \frac{40}{13} \\
R_g &amp;= \frac{\BuoyancyGrad}{|S|^2} \\
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><p><a href="#Shear-production-1">Shear production</a> (<span>$S$</span>).</p></li><li><p><a href="#Monin-Obhukov-length-1">Monin-Obhukov length</a> (<span>$\MOLen$</span>).</p></li><li><p><a href="#Buoyancy-gradient-1">Buoyancy gradient</a> (<span>$\BuoyancyGrad$</span>).</p></li></ul><h2><a class="nav-anchor" id="Mixing-length-1" href="#Mixing-length-1">Mixing length</a></h2><div class="admonition note"><div class="admonition-title">Note</div><div class="admonition-text"><p>These mixing length have been tested for the environment, not the updrafts</p></div></div><div>\[\begin{align}\label{eq:MixingLength}
\SDio{{l_{mix}^m,}} &amp;= \frac{\sum_j l_j e^{-l_j}}{\sum_j e^{-l_j}}, \qquad j = 1,2,3 \\
l_1 &amp;= \frac{\sqrt{c_w\SDe{TKE}}}{\SDe{N}} \\
c_w &amp;= 0.4 \\
\SDe{N} &amp;= \frac{\grav \PD_z \SDe{\ThetaVirt}}{\SDe{\ThetaVirt}} , \qquad \text{(buoyancy frequency of environment)} \\
l_2 &amp;= \frac{\VKConst z}{c_K \kappa^* \phi_m(z/\MOLen)} \\
\phi_m(\xi) &amp;= \left( 1 + a_l \xi \right)^{-b_l} \\
(a_l, b_l) &amp;=
\begin{cases}
  (-100, 0.2) &amp; \MOLen &lt; 0 \\
  (2.7, -1) &amp; \text{otherwise} \\
\end{cases} \\
\kappa^* &amp;= \frac{\FrictionVelocity}{\sqrt{\SDe{TKE}}} \\
l_3 &amp;= \sqrt{\frac{c_{\varepsilon}}{c_K}} \sqrt{\SDe{TKE}}
\left[ \max(|S|^2 - \frac{1}{Pr(z)} \BuoyancyGrad, 0) \right]^{-1/2} \\
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><p><a href="#Constants-1">Constants</a>.</p></li><li><p><a href="#Shear-production-1">Shear production</a> (<span>$S$</span>).</p></li><li><p><a href="#Monin-Obhukov-length-1">Monin-Obhukov length</a> (<span>$\MOLen$</span>).</p></li><li><p><a href="#Friction-velocity-1">Friction velocity</a> (<span>$\FrictionVelocity$</span>).</p></li><li><p><a href="#Buoyancy-gradient-1">Buoyancy gradient</a> (<span>$\BuoyancyGrad$</span>).</p></li><li><p><a href="#Potential-temperatures-1">Potential temperatures</a> (<span>$\ThetaDry$</span>, <span>$\ThetaVirt$</span>).</p></li><li><p><a href="#Prandtl-number-1">Prandtl number</a> (<span>$Pr$</span>).</p></li></ul><p>Smoothing function is provided in python file. The Prandtl number was used from Eq. 75 in Dan Li 2019 &quot;Turbulent Prandtl number in the atmospheric BL - where are we now&quot;.</p><h2><a class="nav-anchor" id="Eddy-diffusivity-1" href="#Eddy-diffusivity-1">Eddy diffusivity</a></h2><div>\[\begin{align}\label{eq:EddyDiffusivity}
\SDi{\Km} &amp; = \begin{cases}
c_K \SDio{{l_{mix},}} \sqrt{\SDi{TKE}} &amp; i = \iEnv \\
0 &amp; \text{otherwise}
\end{cases} \\
\SDi{\Kh} &amp; = \frac{\SDi{\Km}}{Pr} \\
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><p><a href="#Constants-1">Constants</a>.</p></li><li><p><a href="#Mixing-length-1">Mixing length</a> (<span>$l_{mix}$</span>).</p></li><li><p><a href="#Prandtl-number-1">Prandtl number</a> (<span>$Pr$</span>).</p></li></ul><h2><a class="nav-anchor" id="Buoyancy-flux-1" href="#Buoyancy-flux-1">Buoyancy flux</a></h2><div class="admonition todo"><div class="admonition-title">Todo</div><div class="admonition-text"><p>Currently, <span>$\BuoyancyFlux$</span> is hard-coded from the first expression (which was used in SCAMPy), however, this value should be computed from the SurfaceFluxes section.</p></div></div><div>\[\begin{align}\label{eq:BuoyancyFlux}
\SurfaceBuoyancyFlux &amp; = \frac{\grav \BC{\alphaRef}}{\Cpm \BC{\SDi{T}}} (\SensibleSurfaceHeatFlux + (\EpsDV - 1) \Cpm \BC{\SDi{T}} \LatentSurfaceHeatFlux / \LatentHeatV{\BC{\SDi{T}}}) \\
\BuoyancyFlux &amp; = - \SDi{\Kh} \SDi{\BuoyancyGrad} \\
\end{align}\]</div><ul><li><p><a href="#Eddy-diffusivity-1">Eddy diffusivity</a> (<span>$\Km, \Kh$</span>).</p></li><li><p><a href="#Latent-heat-1">Latent heat</a> (<span>$\LatentHeatV{T}$</span>).</p></li><li><p><a href="#Buoyancy-gradient-1">Buoyancy gradient</a> (<span>$\BuoyancyGrad$</span>).</p></li><li><p><a href="#Specific-heats-1">Specific heats</a> <span>$\Cpm$</span> and <span>$\Cvm$</span>.</p></li></ul><h2><a class="nav-anchor" id="Entrainment-Detrainment-1" href="#Entrainment-Detrainment-1">Entrainment-Detrainment</a></h2><p>Entrainment (<span>$\epsilon_{i}$</span>)</p><div>\[\begin{align}\label{eq:Entrainment}
\epsilon_{i} &amp;= c_{\epsilon} \frac{\max(\SDi{b}, 0)}{\SDi{w}^2} \\
c_{\epsilon} &amp;= 0.12 \\
\end{align}\]</div><p>Detrainment (<span>$\delta_{j}$</span>):</p><div>\[\begin{align}\label{eq:Detrainment}
\delta_{i} &amp;= c_{\delta} \frac{|\min(\SDi{b}, 0)|}{\SDi{w}^2} + \delta_{B} \Heaviside(\SDi{\ql}) \\
c_{\delta} &amp;= c_{\delta,0} + \Gamma(\aSDi{a}) \\
\Gamma(\aSDi{a}) &amp;= 0 \\
c_{\delta,0} &amp;= c_{\epsilon} = 0.12 \\
\delta_B &amp;= 0.004 [m^{-1}] \\
\Heaviside &amp;= \text{Heaviside function} \\
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><p><a href="#Reference-state-profiles-1">Reference state profiles</a> (<span>$\pRef{}$</span>, <span>$\rhoRef{}$</span>, and <span>$\alphaRef{}$</span>).</p></li><li><p><a href="#Temperature-1">Temperature</a> (<span>$T$</span> and <span>$\TDry$</span>).</p></li><li><p><a href="#Buoyancy-1">Buoyancy</a> (<span>$\Buoyancy$</span>).</p></li></ul><h2><a class="nav-anchor" id="Inversion-height-1" href="#Inversion-height-1">Inversion height</a></h2><div>\[\begin{align}\label{eq:InversionHeight}
\SDio{\InversionHeight} &amp;=
\begin{cases}
  \left[ (\PD_z \ThetaRho)^{-1} (\BC{\ThetaRho} - \ThetaRho|_{z_1}) + z_1 \right] &amp; \simparam{\BC{\DM{u}}}^2 + \simparam{\BC{\DM{v}}}^2 &lt;= \text{tol}_{\InversionHeight\mathrm{-stable}} \\
  \left[ (\PD_z Ri_{bulk})^{-1} (\hyperparam{Ri_{bulk, crit}} - Ri_{bulk}|_{z_2}) + z_2 \right] &amp; \text{otherwise} \\
\end{cases} \\
z_1 &amp;= \min_z (\ThetaRho(z) &gt; \BC{\ThetaRho}) \\
z_2 &amp;= \min_z (Ri_{bulk}(z) &gt; \hyperparam{Ri_{bulk, crit}}) \\
Ri_{bulk} &amp;= \grav z \frac{(\ThetaRho/\BC{\ThetaRho} - 1)}{\simparam{\DM{u}}^2 + \simparam{\DM{v}}^2} \\
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><a href="#Potential-temperatures-1">Potential temperatures</a> (<span>$\theta$</span>).</li></ul><h2><a class="nav-anchor" id="Convective-velocity-1" href="#Convective-velocity-1">Convective velocity</a></h2><div>\[\begin{align}\label{eq:ConvectiveVelocity}
\SDio{\ConvectiveVelocity} &amp;= (\max(\BuoyancyFlux \SDio{\InversionHeight}, 0))^{1/3} \\
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><p><a href="#Inversion-height-1">Inversion height</a> (<span>$\SDio{\InversionHeight}$</span>).</p></li><li><p><a href="#Buoyancy-flux-1">Buoyancy flux</a> (<span>$\BuoyancyFlux$</span>).</p></li></ul><h2><a class="nav-anchor" id="Non-local-mixing-length-1" href="#Non-local-mixing-length-1">Non-local mixing length</a></h2><div>\[\begin{align}\label{eq:MixingLengthOld}
\SDio{{l_{mix},}} &amp;= (l_A^{-1} + l_B^{-1})^{-1} \\
l_A &amp;= \VKConst z \left( 1 + a_l \frac{z}{\MOLen} \right)^{b_l} \\
\SDio{{l_B}} &amp;= \SDio{\tau} \SDi{TKE} \\
(a_l, b_l) &amp;=
\begin{cases}
  (-100, 0.2) &amp; \MOLen &lt; 0 \\
  (2.7, -1) &amp; \text{otherwise} \\
\end{cases} \\
\SDio{\tau} &amp;= \SDio{\InversionHeight}/\SDio{\ConvectiveVelocity} \\
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><p><a href="#Inversion-height-1">Inversion height</a> (<span>$\SDio{\InversionHeight}$</span>).</p></li><li><p><a href="#Monin-Obhukov-length-1">Monin-Obhukov length</a> (<span>$\MOLen$</span>).</p></li><li><p><a href="#Convective-velocity-1">Convective velocity</a> (<span>$\SDio{\ConvectiveVelocity}$</span>).</p></li></ul><h1><a class="nav-anchor" id="Boundary-Conditions-1" href="#Boundary-Conditions-1">Boundary Conditions</a></h1><p>Here, we specify boundary conditions (BCs) by their type, Dirichlet (D) or Neumann (N), and their value.</p><h2><a class="nav-anchor" id="BC-functions-1" href="#BC-functions-1">BC functions</a></h2><div>\[\begin{align}
\Gamma_{\phi}(F_1, F_2)
&amp; = \begin{cases}
    4 \frac{F_1 F_2}{\FrictionVelocity^2} (1 - 8.3\zLL/\MOLen)^{-2/3} &amp; \MOLen &lt; 0 \\
    4 \frac{F_1 F_2}{\FrictionVelocity^2} &amp; \text{otherwise}
\end{cases} \\
\Gamma_{TKE}
&amp; = \begin{cases}
    3.75 {\FrictionVelocity}^2 + 0.2 {\ConvectiveVelocity}^2 + {\FrictionVelocity}^2 (-\zLL/\MOLen)^{2/3} &amp; \MOLen &lt; 0 \\
    3.75 {\FrictionVelocity}^2 &amp; \text{otherwise}
\end{cases} \\
\SensibleSurfaceHeatFlux &amp; = \BC{\TCV{w}{\eint}} \Cpm \rhoRef \\
\LatentSurfaceHeatFlux   &amp; = \BC{\TCV{w}{\qt}}  \LatentHeatV{T} \rhoRef \\
F_{\eint}(\SensibleSurfaceHeatFlux)  &amp; = \frac{\SensibleSurfaceHeatFlux}{\Cpm}       = \BC{\TCV{w}{\eint}} \rhoRef \\
F_{\qt}(\LatentSurfaceHeatFlux)      &amp; = \frac{\LatentSurfaceHeatFlux}{\LatentHeatV{T}} = \BC{\TCV{w}{\qt}}   \rhoRef \\
\end{align}\]</div><p>where additional variable definitions are in:</p><ul><li><p><a href="#Reference-state-profiles-1">Reference state profiles</a> (<span>$\pRef{}$</span>, <span>$\rhoRef{}$</span>, and <span>$\alphaRef{}$</span>).</p></li><li><p><a href="#Monin-Obhukov-length-1">Monin-Obhukov length</a> (<span>$\MOLen$</span>).</p></li><li><p><a href="#Convective-velocity-1">Convective velocity</a> (<span>$\SDio{\ConvectiveVelocity}$</span>).</p></li><li><p><a href="#Friction-velocity-1">Friction velocity</a> (<span>$\FrictionVelocity$</span>).</p></li><li><p><a href="#Latent-heat-1">Latent heat</a> (<span>$\LatentHeatV{T}$</span>).</p></li></ul><p>and equation \eqref{eq:TopPercentile} represents the mean of the top <span>$x$</span>-fraction of a standard normal distribution (Neggers et al., 2009).</p><div>\[\begin{align}
\Phi^{-1}(x)  &amp;= \text{inverse cumulative distribution function}, \label{eq:InverseCDF} \\
\mathcal D(x) &amp;= \frac{1}{\sqrt{2\pi x}} \exp{- \frac{1}{2} (\Phi^{-1}(1-x))^2 } , \label{eq:TopPercentile} \\
\end{align}\]</div><h2><a class="nav-anchor" id="Area-fraction-1" href="#Area-fraction-1">Area fraction</a></h2><div>\[\begin{align}
c_{frac} = 0.1, \quad
\BCB{\aSDi{a}} =
\begin{cases}
    1-c_{frac}, &amp; i = \iEnv{} \\
  \frac{c_{frac}}{\Nsd}, &amp; i \ne \iEnv{}
\end{cases}, \quad
\BCT{\aSDi{a}} =
\begin{cases}
    1-c_{frac}, &amp; i = \iEnv{} \\
  \frac{c_{frac}}{\Nsd}, &amp; i \ne \iEnv{}
\end{cases}
\end{align}\]</div><h2><a class="nav-anchor" id="st-order-moments-1" href="#st-order-moments-1">1st order moments</a></h2><p>Top boundary</p><div>\[\begin{align}
\BCT{\SDi{w}}           &amp;= 0 \\
\PD_z \BCT{\SDi{\qt}}   &amp;= 0 \\
\PD_z \BCT{\SDi{\eint}} &amp;= 0 \\
\end{align}\]</div><p>Bottom boundary</p><div class="admonition todo"><div class="admonition-title">Todo</div><div class="admonition-text"><p>Need value for <span>$C_{\eint}$</span>.</p></div></div><div>\[\begin{align}
\BCB{\SDi{w}}     &amp;= 0 \\
- \SDi{\Kh} \PD_z \BCB{\SDi{\qt}}   &amp;= \TCV{w}{\qt}   + \mathcal D(\aSDi{a}) \sqrt{C_{\qt}^2   \WindSpeed^2\Gamma_{\phi}(\TCV{w}{\qt}  , \TCV{w}{\qt}   )} \\
- \SDi{\Kh} \PD_z \BCB{\SDi{\eint}} &amp;= \TCV{w}{\eint} + \mathcal D(\aSDi{a}) \sqrt{C_{\eint}^2 \WindSpeed^2\Gamma_{\phi}(\TCV{w}{\eint}, \TCV{w}{\eint} )} \\
C_{\qt} &amp;= 0.001133 \\
C_{\ThetaLiqIce} &amp;= 0.001094 \\
C_{\eint} &amp;=  \\
\end{align}\]</div><p>where additional variable/function definitions are in:</p><ul><li><a href="#BC-functions-1">BC functions</a> <span>$\mathcal D$</span>.</li></ul><h2><a class="nav-anchor" id="nd-order-moments-1" href="#nd-order-moments-1">2nd order moments</a></h2><p>Top boundary</p><div>\[\begin{align}
\BCT{\SDi{TKE}}                         &amp; = 0 \\
\PD_z \BCT{\IntraCVSDi{\qt}{\qt}}       &amp; = 0 \\
\PD_z \BCT{\IntraCVSDi{\eint}{\eint}}   &amp; = 0 \\
\PD_z \BCT{\IntraCVSDi{\eint}{\qt}}     &amp; = 0 \\
\end{align}\]</div><div class="admonition todo"><div class="admonition-title">Todo</div><div class="admonition-text"><p>Currently, we only account for the <em>intra</em> sub-domain covariance, but we would like to also account for the <em>inter</em> sub-domain covariance for all but the <span>$TKE$</span>.</p></div></div><p>Bottom boundary</p><div>\[\begin{align}
\BCB{\SDi{TKE}}                   &amp; = \Gamma_{TKE} \\
\BCB{\IntraCVSDi{\qt}{\qt}}       &amp; = \Gamma_{\phi}(\TCV{w}{\qt}  , \TCV{w}{\qt}   ) \\
\BCB{\IntraCVSDi{\eint}{\eint}}   &amp; = \Gamma_{\phi}(\TCV{w}{\qt}  , \TCV{w}{\eint} ) \\
\BCB{\IntraCVSDi{\eint}{\qt}}     &amp; = \Gamma_{\phi}(\TCV{w}{\eint}, \TCV{w}{\eint} ) \\
\end{align}\]</div><p>where additional variable/function definitions are in:</p><ul><li><a href="#BC-functions-1">BC functions</a> <span>$\Gamma_{TKE}$</span>, <span>$\Gamma_{\phi}$</span>, <span>$F_{\eint}$</span>, <span>$\SensibleSurfaceHeatFlux$</span>, <span>$F_{\qt}$</span>, <span>$\LatentSurfaceHeatFlux$</span>.</li></ul><h2><a class="nav-anchor" id="Case-specific-configurations-1" href="#Case-specific-configurations-1">Case-specific configurations</a></h2><table><tr><th style="text-align: left"><strong>Case</strong></th><th style="text-align: right"><strong>Variable</strong></th><th style="text-align: right"><strong>Value</strong></th><th style="text-align: right"><strong>Reference</strong></th></tr><tr><td style="text-align: left">Bomex</td><td style="text-align: right"><span>$\BC{p_s}$</span></td><td style="text-align: right">1000 [hPa]</td><td style="text-align: right"></td></tr><tr><td style="text-align: left">Bomex</td><td style="text-align: right"><span>$\BC{\DM{\qt}}$</span></td><td style="text-align: right">5 [g/kg]</td><td style="text-align: right"></td></tr><tr><td style="text-align: left">Bomex</td><td style="text-align: right"><span>$\BC{\DM{\ThetaLiqIce}}$</span></td><td style="text-align: right">300 [K]</td><td style="text-align: right"></td></tr><tr><td style="text-align: left">Bomex</td><td style="text-align: right"><span>$\BC{\TCV{w}{\qt}}$</span></td><td style="text-align: right"><span>$5.2 \times 10^{-5} [m s^{-1}]$</span></td><td style="text-align: right"></td></tr><tr><td style="text-align: left">Bomex</td><td style="text-align: right"><span>$\BC{\TCV{w}{\ThetaLiqIce}}$</span></td><td style="text-align: right"><span>$8 \times 10^{-3} [K m s^{-1}]$</span></td><td style="text-align: right"></td></tr><tr><td style="text-align: left">Soares</td><td style="text-align: right"><span>$\BC{\TCV{w}{\qt}}$</span></td><td style="text-align: right"><span>$2.5 \times 10^{-5} [m s^{-1}]$</span></td><td style="text-align: right"></td></tr><tr><td style="text-align: left">Soares</td><td style="text-align: right"><span>$\BC{\TCV{w}{\ThetaLiqIce}}$</span></td><td style="text-align: right"><span>$6 \times 10^{-2} [K m s^{-1}]$</span></td><td style="text-align: right"></td></tr><tr><td style="text-align: left"></td><td style="text-align: right"></td><td style="text-align: right"></td><td style="text-align: right"></td></tr></table><footer><hr/><a class="previous" href="../TurbulenceConvection/"><span class="direction">Previous</span><span class="title"><code>TurbulenceConvection</code></span></a><a class="next" href="../../ODESolvers/"><span class="direction">Next</span><span class="title">ODESolvers</span></a></footer></article></body></html>
